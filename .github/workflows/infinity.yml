name: Build Infinity

on:
  workflow_dispatch:
  
env:
  # JAVA_HOME = /usr/lib/jvm/temurin-11-jdk-amd64
  # ANDROID_SDK_ROOT = /usr/local/lib/android/sdk
  # Setting an environment variable with the value of a configuration variable
  VARIANT: ${{ vars.VARIANT_INFINITY }}
  REPO: 'Docile-Alligator/Infinity-For-Reddit'
  REDIRECT_URL: 'http://127.0.0.1'
  API_TOKEN: ${{ secrets.API_TOKEN-INFINITY }}
  USER_AGENT: "android:github_ci-app:0.${{ github.run_number }}.${{ github.run_attempt }} built by ${{ github.actor }}"
  
env:
  # setup colors
  RED_COLOR: "\e[1;31m"
  ORANGE_COLOR: "\e[1;33m"
  BLUE_COLOR: "\e[0;34m"
  BOLD_TEXT: "\e[1m"
  UNSET_COLOR: "\e[0m"

permissions:
  contents: write

jobs:
  build_job:
    runs-on: ubuntu-22.04
    name: Build Infinity for reddit.

    steps:
      - name: Set-up PATH and update runner.
        shell: bash
        run: |
          echo "/usr/local/lib/android/sdk/tools/bin:/usr/local/lib/android/sdk/platform-tools" >> $GITHUB_PATH
          PATH="$PATH":"/usr/local/lib/android/sdk/tools/bin:/usr/local/lib/android/sdk/platform-tools"

          sudo apt-get --quiet update
          sudo apt-get --quiet upgrade
          
          env
          
          yes | sdkmanager  --sdk_root=${ANDROID_SDK_ROOT} "platforms;android-33" "build-tools;33.0.0"
        
      - name: Checkout Infinity-For-Reddit repository.
        if: ${{ env.VARIANT == 'git' }}
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          show-progress: false
          repository: ${{ env.REPO }}

      - name: Fetch source archive.
        if: ${{ env.VARIANT != 'git' }}
        shell: bash
        run: |
          printf "${RED_COLOR}[IMPORTANT]\n"
          printf "Using archive as source package.${UNSET_COLOR}\n"

          latest_tag=$(curl -s "https://api.github.com/repos/${REPO}/releases/latest" \
            | grep "\"tag_name\":" | cut -d \" -f 4)
              
          latest_url="https://github.com/${REPO}/archive/refs/tags/${latest_tag}.tar.gz"
            
          wget --quiet -O "${REPO#*/}.tar.gz" "${latest_url}" && \
          tar xf  "${REPO#*/}.tar.gz" && \
          mv "${REPO#*/}-${latest_tag#*v}" "${REPO#*/}" && \
          rm -f "${REPO#*/}.tar.gz"
